# Спецификация API

Этот документ описывает REST API и события WebSocket, используемые для взаимодействия клиента и сервера.

---

## 1. REST API

### 1.1. Аутентификация (`/v1/users`)

#### `POST /v1/users`

- **Назначение:** Регистрация нового пользователя.
- **Request Body (`application/json`):**

| Поле | Тип | Описание | Обязательное |
| --- | --- | --- | --- |
| `email` | String | Email пользователя | Да |
| `password`| String | Пароль (мин. 6 символов) | Да |

- **Responses:**
  - **`201 Created`**: Пользователь успешно создан. Возвращает объект `UserDto`.
  - **`400 Bad Request`**: Ошибки валидации (например, невалидный email, короткий пароль).
  - **`409 Conflict`**: Пользователь с таким email уже существует.

#### `POST /v1/users/login`

- **Назначение:** Аутентификация пользователя и получение JWT токенов.
- **Request Body (`application/json`):**

| Поле | Тип | Описание | Обязательное |
| --- | --- | --- | --- |
| `email` | String | Email пользователя | Да |
| `password`| String | Пароль | Да |

- **Responses:**
  - **`201 Created`**: Успешная аутентификация.
  - JWT-токены (`accessToken`, `refreshToken`) устанавливаются в cookie (httpOnly, sameSite=lax, secure в production).
  - **Тело ответа:** Пустое (токены только в cookies).
  - **`401 Unauthorized`**: Неверные учетные данные.

#### `GET /v1/users/me`

- **Назначение:** Получение информации о текущем аутентифицированном пользователе.
- **Cookie:**
  - `accessToken` — должен быть установлен в браузере (httpOnly cookie).
- **Responses:**
  - **`200 OK`**: Данные пользователя (объект `UserDto`).
  - **`401 Unauthorized`**: Неавторизованный запрос.

---

### 1.2. Игровые сессии (`/v1/games`)

#### `POST /v1/games`

- **Назначение:** Создать новую игровую сессию.
- **Cookie:**
  - `accessToken` — должен быть установлен в браузере (httpOnly cookie).
- **Request Body:** Отсутствует (сессия создается без параметров).
- **Responses:**
  - **`201 Created`**: Игровая сессия создана. Возвращает объект `GameSessionDto` со статусом `GENERATING_MAP` (карта генерируется асинхронно).

#### `GET /v1/games/{gameId}`

- **Назначение:** Получить полное состояние указанной игровой сессии.
- **Cookie:**
  - `accessToken` — должен быть установлен в браузере (httpOnly cookie).
- **Path Parameters:**
  - `gameId` (UUID): Идентификатор игровой сессии.
- **Responses:**
  - **`200 OK`**: Возвращает объект `GameSessionDto`.
  - **`404 Not Found`**: Игра не найдена.

#### `POST /v1/games/{gameId}/players`

- **Назначение:** Отправить запрос на присоединение к игровой сессии.
- **Cookie:**
    - `accessToken` — должен быть установлен в браузере (httpOnly cookie).
- **Request Body:** Отсутствует.
- **Responses:**
    - **`202 Accepted`**: Запрос на присоединение принят и обрабатывается. Клиент должен ожидать обновления состояния по WebSocket.
    - **`401 Unauthorized`**: Неавторизованный запрос.
    - **`404 Not Found`**: Игра не найдена.
    - **`409 Conflict`**: Сессия заполнена или не принимает новых игроков.

#### `POST /v1/games/{gameId}/buildings`

- **Назначение:** Построить новое здание.
- **Cookie:**
  - `accessToken` — должен быть установлен в браузере (httpOnly cookie).
- **Request Body (`application/json`):**

| Поле | Тип | Описание | Обязательное |
| --- | --- | --- | --- |
| `type` | Enum | Тип строящегося здания | Да |
| `position`| JSON | Координаты `{"x": number, "y": number}` | Да |

- **Responses:**
  - **`201 Created`**: Возвращает созданный объект `Building`.
  - **`400 Bad Request`**: Недостаточно ресурсов или неверное место для постройки.

---

## 2. DTO объекты

### 2.1. UserDto

**Описание:** Объект пользователя, возвращаемый API.

| Поле | Тип | Описание | Пример |
|------|-----|----------|---------|
| `id` | UUID | Уникальный идентификатор пользователя | `"a1b2c3d4-e5f6-7890-1234-567890abcdef"` |
| `email` | String | Email пользователя | `"test@example.com"` |
| `createdAt` | String | Дата создания (ISO 8601) | `"2023-10-27T10:00:00.000Z"` |
| `updatedAt` | String | Дата обновления (ISO 8601) | `"2023-10-27T10:00:00.000Z"` |

### 2.2. GameSessionDto

**Описание:** Объект игровой сессии.

| Поле | Тип | Описание | Пример |
|------|-----|----------|---------|
| `id` | UUID | Уникальный идентификатор сессии | `"a1b2c3d4-e5f6-7890-1234-567890abcdef"` |
| `mapId` | UUID \| null | Идентификатор карты | `"b2c3d4e5-f6a7-8901-2345-67890abcdef1"` |
| `status` | Enum | Статус игры | `"GENERATING_MAP"`, `"WAITING"`, `"IN_PROGRESS"`, `"FINISHED"` |
| `createdAt` | String | Дата создания (ISO 8601) | `"2023-10-27T10:00:00.000Z"` |
| `finishedAt` | String \| null | Дата завершения (ISO 8601) | `"2023-10-27T11:00:00.000Z"` |

### 2.3. PlayerDto

**Описание:** Объект игрока в сессии.

| Поле | Тип | Описание | Пример |
|------|-----|----------|---------|
| `id` | UUID | Уникальный идентификатор игрока | `"a1b2c3d4-e5f6-7890-1234-567890abcdef"` |
| `userId` | UUID | Идентификатор пользователя | `"b2c3d4e5-f6a7-8901-2345-67890abcdef1"` |
| `gameSessionId` | UUID | Идентификатор игровой сессии | `"c3d4e5f6-a7b8-9012-3456-7890abcdef12"` |
| `resources` | Object | Ресурсы игрока | `{"gold": 1000, "crystals": 50}` |
| `isWinner` | Boolean \| undefined | Флаг победителя | `false` |

### 2.4. MapDto

**Описание:** Объект игровой карты.

| Поле | Тип | Описание | Пример |
|------|-----|----------|---------|
| `id` | UUID | Уникальный идентификатор карты | `"a1b2c3d4-e5f6-7890-1234-567890abcdef"` |
| `size` | Object | Размеры карты | `{"width": 100, "height": 100}` |
| `terrainData` | Array<Array<TerrainType>> | 2D массив типов местности | `[["Dirt", "Rock"], ["Bedrock", "Dirt"]]` |
| `spawnPoints` | Array | Точки спавна игроков | `[{"x": 10, "y": 10}, {"x": 90, "y": 90}]` |

**TerrainType enum:**
- `"Dirt"` - Земля
- `"Rock"` - Камень
- `"Bedrock"` - Скальная порода

---

## 3. WebSocket API

Клиент подключается к WebSocket после присоединения к игровой сессии. Сервер использует его для рассылки обновлений в реальном времени.

### 3.1. События от сервера (Server -> Client)

- `game_state_update`: Общее событие, которое может содержать батч изменений.
  - **Payload:** `{ units: [...], buildings: [...], players: [...] }`
- `unit_spawned`: Появился новый юнит.
  - **Payload:** Объект `Unit`.
- `unit_moved`: Юнит изменил свою позицию.
  - **Payload:** `{ unitId: UUID, newPosition: {x, y} }`
- `resource_updated`: Изменилось количество ресурсов у игрока.
  - **Payload:** `{ playerId: UUID, resources: { gold, crystals } }`
- `terrain_dug`: Был раскопан участок карты.
  - **Payload:** `{ position: {x, y} }`
- `building_created`: Было построено новое здание.
  - **Payload:** Объект `Building`.

### 3.2. События от клиента (Client -> Server)

В данной архитектуре клиент использует REST API для отправки команд. WebSocket используется преимущественно для получения данных от сервера, чтобы упростить логику и разделение ответственности. Однако, в будущем могут быть добавлены события от клиента для действий, требующих минимальной задержки.
