# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∫–∞—Ä—Ç

> **‚ö†Ô∏è TODO:** –î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ö–∞—Ä—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ JSON-–ø–æ–ª–µ `terrainData: TerrainType[][]` –≤ PostgreSQL
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ –º–∞—Å—Å–∏–≤–∞
- –ö–∞—Ä—Ç—ã –¥–æ 1000√ó1000 –∫–ª–µ—Ç–æ–∫ = –¥–æ **15 –ú–ë** –¥–∞–Ω–Ω—ã—Ö
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–∫—Ç–æ—Ä—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∏–∑–º–µ–Ω—è—é—Ç –∫–∞—Ä—Ç—É
- –ö–ª–∏–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—Ç–∞–π–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
1. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫:** –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–π –∫–∞—Ä—Ç—ã –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
2. **–ó–∞–¥–µ—Ä–∂–∫–∏ –ë–î:** –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö JSON-–æ–±—ä–µ–∫—Ç–æ–≤
3. **–ü–∞–º—è—Ç—å –∫–ª–∏–µ–Ω—Ç–∞:** –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π –∫–∞—Ä—Ç—ã
4. **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–µ—à–µ–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **Area of Interest (AOI):** –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
- **Chunking:** –†–∞–∑–±–∏–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –±–ª–æ–∫–∏
- **Delta Updates:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **Viewport-based Loading:** –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

---

## üìÖ –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### **Phase 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–∞–Ω–∫–æ–≤** ‚è±Ô∏è 2-3 –Ω–µ–¥–µ–ª–∏

#### 1.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
```sql
-- TODO: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —á–∞–Ω–∫–æ–≤ –∫–∞—Ä—Ç—ã
CREATE TABLE map_chunks (
    map_id UUID REFERENCES maps(id),
    chunk_x INTEGER NOT NULL,
    chunk_y INTEGER NOT NULL,
    chunk_data JSONB NOT NULL,
    version INTEGER DEFAULT 1,
    last_modified TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (map_id, chunk_x, chunk_y)
);

CREATE INDEX idx_map_chunks_version ON map_chunks(map_id, version);
CREATE INDEX idx_map_chunks_modified ON map_chunks(last_modified);
```

#### 1.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma —Å—Ö–µ–º—ã
```prisma
// TODO: –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å MapChunk
model MapChunk {
  mapId       String   @map("map_id")
  chunkX      Int      @map("chunk_x")
  chunkY      Int      @map("chunk_y")
  data        Json     // TerrainCell[] –¥–ª—è —á–∞–Ω–∫–∞ 32x32
  version     Int      @default(1)
  lastModified DateTime @default(now()) @map("last_modified")

  map Map @relation(fields: [mapId], references: [id])

  @@id([mapId, chunkX, chunkY])
  @@map("map_chunks")
}

// TODO: –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å Map
model Map {
  id            String      @id @default(uuid())
  gameSessionId String      @unique @map("game_session_id")
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id])
  size          Json        // –û—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  spawnPoints   Json        @map("spawn_points") // –û—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  chunks        MapChunk[]  // –ù–æ–≤–∞—è —Å–≤—è–∑—å

  // TODO: –£–¥–∞–ª–∏—Ç—å terrainData –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
  // terrainData   Json        @map("terrain_data")

  @@map("maps")
}
```

#### 1.3 –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª libs/domain-primitives/src/map-chunk.value-object.ts
interface TerrainCell {
  x: number;           // –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
  y: number;           // –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
  terrain: TerrainType;
  lastModified: number; // timestamp
}

interface MapChunk {
  chunkId: string;      // "x_y" —Ñ–æ—Ä–º–∞—Ç
  mapId: string;
  chunkX: number;       // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —á–∞–Ω–∫–∞
  chunkY: number;       // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —á–∞–Ω–∫–∞
  size: number;         // –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (32x32)
  data: TerrainCell[];  // –î–∞–Ω–Ω—ã–µ –∫–ª–µ—Ç–æ–∫
  version: number;      // –í–µ—Ä—Å–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
  lastModified: Date;
}

interface TerrainDelta {
  type: 'terrain_change';
  mapId: string;
  changes: Array<{
    x: number;
    y: number;
    oldTerrain: TerrainType;
    newTerrain: TerrainType;
    timestamp: number;
    playerId?: string;
  }>;
  chunkIds: string[];   // –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —á–∞–Ω–∫–∏
}
```

### **Phase 2: –°–µ—Ä–≤–∏—Å—ã –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** ‚è±Ô∏è 2-3 –Ω–µ–¥–µ–ª–∏

#### 2.1 MapChunkService
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å apps/backend/src/map/domain/map-chunk.service.ts
@Injectable()
export class MapChunkService {
  private readonly CHUNK_SIZE = 32;

  // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã
  async getChunksInViewport(mapId: string, centerX: number, centerY: number, viewWidth: number, viewHeight: number): Promise<MapChunk[]>
  async getChunksInRange(mapId: string, startChunkX: number, endChunkX: number, startChunkY: number, endChunkY: number): Promise<MapChunk[]>
  async updateTerrain(mapId: string, x: number, y: number, newTerrain: TerrainType): Promise<TerrainDelta>
  async updateChunkCell(mapId: string, chunkX: number, chunkY: number, x: number, y: number, newTerrain: TerrainType): Promise<MapChunk>
  async getChunkByCoords(mapId: string, chunkX: number, chunkY: number): Promise<MapChunk | null>
  async createChunk(mapId: string, chunkX: number, chunkY: number, data: TerrainCell[]): Promise<MapChunk>
}
```

#### 2.2 MapChunkRepository
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å apps/backend/src/map/db/map-chunk.repository.ts
@Injectable()
export class MapChunkRepository {
  // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —á–∞–Ω–∫–æ–≤
  async create(chunk: MapChunk): Promise<MapChunkDb>
  async findByMapAndCoords(mapId: string, chunkX: number, chunkY: number): Promise<MapChunkDb | null>
  async findChunksInRange(mapId: string, minX: number, maxX: number, minY: number, maxY: number): Promise<MapChunkDb[]>
  async updateChunkData(mapId: string, chunkX: number, chunkY: number, data: TerrainCell[]): Promise<MapChunkDb>
  async incrementVersion(mapId: string, chunkX: number, chunkY: number): Promise<void>
}
```

#### 2.3 –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ä—Ç
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ apps/backend/src/scripts/migrate-maps-to-chunks.ts
export class MapMigrationService {
  async migrateExistingMaps(): Promise<void> {
    // –ß–∏—Ç–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç—ã
    // –†–∞–∑–±–∏–≤–∞–µ–º terrainData –Ω–∞ —á–∞–Ω–∫–∏
    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏ –≤ map_chunks
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º terrainData –∏–∑ maps
  }
}
```

### **Phase 3: WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** ‚è±Ô∏è 3-4 –Ω–µ–¥–µ–ª–∏

#### 3.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MapSyncGateway
```typescript
// TODO: –û–±–Ω–æ–≤–∏—Ç—å apps/backend/src/map/api/map.gateway.ts
@WebSocketGateway()
export class MapSyncGateway {
  private playersViewports = new Map<string, ViewportInfo>();

  // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã
  @SubscribeMessage('viewport_update')
  async handleViewportUpdate(@MessageBody() data: ViewportRequest, @ConnectedSocket() client: Socket)

  @SubscribeMessage('terrain_dig')
  async handleTerrainDig(@MessageBody() data: { mapId: string, x: number, y: number }, @ConnectedSocket() client: Socket)

  @SubscribeMessage('building_place')
  async handleBuildingPlace(@MessageBody() data: { mapId: string, x: number, y: number, buildingType: string }, @ConnectedSocket() client: Socket)

  private broadcastDeltaToArea(mapId: string, delta: TerrainDelta): void
  private getPlayersInChunks(mapId: string, chunkIds: string[]): string[]
  private updatePlayerViewport(playerId: string, viewport: ViewportInfo): void
}
```

#### 3.2 –ù–æ–≤—ã–µ DTO –¥–ª—è WebSocket
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å apps/backend/src/map/api/map-sync.dto.ts
interface ViewportRequest {
  playerId: string;
  mapId: string;
  centerX: number;
  centerY: number;
  viewWidth: number;
  viewHeight: number;
  currentChunks: string[]; // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏
}

interface ViewportResponse {
  newChunks: MapChunk[];      // –ù–æ–≤—ã–µ —á–∞–Ω–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
  updatedChunks: MapChunk[];  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏
  removedChunks: string[];    // –ß–∞–Ω–∫–∏ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∏–∑ –ø–∞–º—è—Ç–∏
}

interface MapUpdateEvent {
  type: 'map_delta';
  mapId: string;
  deltaId: string;
  delta: TerrainDelta;
  affectedPlayers: string[];
}
```

### **Phase 4: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** ‚è±Ô∏è 2-3 –Ω–µ–¥–µ–ª–∏

#### 4.1 ClientMapManager
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å apps/frontend/src/game/map/ClientMapManager.ts
class ClientMapManager {
  private loadedChunks = new Map<string, MapChunk>();
  private viewportCenter = { x: 0, y: 0 };
  private readonly PRELOAD_RADIUS = 2; // –ß–∞–Ω–∫–æ–≤ –≤–æ–∫—Ä—É–≥ viewport
  private readonly UNLOAD_RADIUS = 4;  // –†–∞–¥–∏—É—Å –≤—ã–≥—Ä—É–∑–∫–∏ —á–∞–Ω–∫–æ–≤

  // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã
  updateViewport(centerX: number, centerY: number): void
  applyDelta(delta: TerrainDelta): void
  getTerrainAt(x: number, y: number): TerrainType | null
  preloadNearbyChunks(centerX: number, centerY: number): void
  unloadDistantChunks(centerX: number, centerY: number): void
  requestChunksForViewport(centerX: number, centerY: number): void
}
```

#### 4.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞—Ä—Ç—ã
```typescript
// TODO: –û–±–Ω–æ–≤–∏—Ç—å apps/frontend/src/game/rendering/MapRenderer.ts
class MapRenderer {
  private chunkCache = new Map<string, HTMLCanvasElement>();

  // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã
  renderChunk(chunk: MapChunk): HTMLCanvasElement
  updateChunkCell(chunkId: string, x: number, y: number, terrain: TerrainType): void
  renderViewport(chunks: MapChunk[], viewportBounds: Rectangle): void
  invalidateChunk(chunkId: string): void
}
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã
```typescript
// TODO: –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
const MAP_CONFIG = {
  CHUNK_SIZE: 32,           // –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –≤ –∫–ª–µ—Ç–∫–∞—Ö
  VIEWPORT_PRELOAD_RADIUS: 2,  // –ß–∞–Ω–∫–æ–≤ –≤–æ–∫—Ä—É–≥ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
  VIEWPORT_UNLOAD_RADIUS: 4,   // –†–∞–¥–∏—É—Å –≤—ã–≥—Ä—É–∑–∫–∏ —á–∞–Ω–∫–æ–≤
  MAX_CHUNKS_PER_CLIENT: 100,  // –õ–∏–º–∏—Ç —á–∞–Ω–∫–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
  DELTA_BATCH_SIZE: 50,        // –ú–∞–∫—Å–∏–º—É–º –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–π –¥–µ–ª—å—Ç–µ
  CHUNK_CACHE_TTL: 300000,     // TTL –∫—ç—à–∞ —á–∞–Ω–∫–æ–≤ (5 –º–∏–Ω—É—Ç)
};
```

### –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ):
- **–¢—Ä–∞—Ñ–∏–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:** ~15 –ú–ë (–≤—Å—è –∫–∞—Ä—Ç–∞)
- **–ü–∞–º—è—Ç—å –∫–ª–∏–µ–Ω—Ç–∞:** ~15 –ú–ë (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** ~200-500ms

#### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–¢—Ä–∞—Ñ–∏–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:** ~50-200 –±–∞–π—Ç (–¥–µ–ª—å—Ç–∞)
- **–ü–∞–º—è—Ç—å –∫–ª–∏–µ–Ω—Ç–∞:** ~2-5 –ú–ë (–∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞–Ω–∫–∏)
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** ~10-50ms

#### –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:
- **–¢—Ä–∞—Ñ–∏–∫:** 99.8% —Å–Ω–∏–∂–µ–Ω–∏–µ
- **–ü–∞–º—è—Ç—å:** 70-80% —Å–Ω–∏–∂–µ–Ω–∏–µ
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î:** 90%+ —É–ª—É—á—à–µ–Ω–∏–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã
describe('MapChunkService', () => {
  it('should split map into correct chunks')
  it('should update terrain and create delta')
  it('should handle chunk boundaries correctly')
  it('should validate chunk coordinates')
})

describe('ClientMapManager', () => {
  it('should load chunks in viewport')
  it('should apply deltas correctly')
  it('should unload distant chunks')
  it('should handle chunk caching')
})
```

### Integration —Ç–µ—Å—Ç—ã
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã
describe('Map Synchronization', () => {
  it('should sync terrain changes between clients')
  it('should handle concurrent modifications')
  it('should maintain consistency during chunk loading')
  it('should recover from connection drops')
})
```

### Performance —Ç–µ—Å—Ç—ã
```typescript
// TODO: –°–æ–∑–¥–∞—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏
describe('Performance Benchmarks', () => {
  it('should handle 1000+ concurrent players')
  it('should maintain <50ms delta delivery')
  it('should limit memory usage per client')
  it('should handle large terrain modifications')
})
```

---

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö
- [ ] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è dual-write (–∑–∞–ø–∏—Å—å –≤ –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev/staging —Å—Ä–µ–¥–∞—Ö

### –≠—Ç–∞–ø 2: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- [ ] –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ä—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] –û—Ç–∫–∞—Ç –ø–ª–∞–Ω –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º

### –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
- [ ] Feature flag –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- [ ] –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –≠—Ç–∞–ø 4: –û—á–∏—Å—Ç–∫–∞
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–µ–π –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### KPI –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- **Reduction in bandwidth usage:** >99% –¥–ª—è terrain updates
- **Client memory usage:** <5MB –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã
- **Delta delivery latency:** <50ms p95
- **Database query performance:** <10ms p95 –¥–ª—è chunk operations
- **Client rendering FPS:** Stable 60fps –≤–æ –≤—Ä–µ–º—è updates

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```typescript
// TODO: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
interface MapOptimizationMetrics {
  chunkLoadsPerSecond: number;
  deltaUpdatesPerSecond: number;
  avgChunkLoadTime: number;
  avgDeltaDeliveryTime: number;
  activeChunksPerClient: number;
  memoryUsagePerClient: number;
}
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

- [ ] **#MAP-001:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è MapChunk –º–æ–¥–µ–ª–∏ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] **#MAP-002:** WebSocket –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è delta updates
- [ ] **#MAP-003:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä —á–∞–Ω–∫–æ–≤
- [ ] **#MAP-004:** –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ä—Ç
- [ ] **#MAP-005:** Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±–µ–Ω—á–º–∞—Ä–∫–∏
- [ ] **#MAP-006:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
- AOI (Area of Interest) patterns –≤ –∏–≥—Ä–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
- Delta compression algorithms
- Spatial partitioning strategies
- Real-time synchronization patterns

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã
- PostgreSQL JSONB performance optimization
- WebSocket broadcasting optimization
- Canvas rendering optimization –¥–ª—è chunk-based maps
- Memory management –¥–ª—è game clients

---

> **‚ö†Ô∏è –í–∞–∂–Ω–æ:** –î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–µ–Ω –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã. –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ –≤—ã–¥–µ—Ä–∂–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –æ—Ç 100+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–µ.

> **‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ü–ª–∞–Ω –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –∫–æ–≥–¥–∞ 1000+ –∏–≥—Ä–æ–∫–æ–≤ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –∫–∞—Ä—Ç–æ–π –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º FPS –∏ –∑–∞–¥–µ—Ä–∂–∫–µ <50ms.