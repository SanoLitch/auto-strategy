# Аналитика карты

## Обзор
Система генерации карт создает сбалансированные игровые карты с зонированным размещением ресурсов, учитывающим стратегическую важность различных областей карты.

## Структура карты

### Типы поверхности
- **Dirt** - Основная поверхность, легко раскапывается
- **Rock** - Каменистая поверхность, средняя сложность раскопки
- **Bedrock** - Неразрушимая коренная порода
- **Empty** - Очищенная территория, готовая для строительства
- **GoldCluster** - Месторождения золота (основной ресурс)
- **CrystalCluster** - Месторождения кристаллов (редкий ресурс)
- **IronCluster** - Месторождения железа (строительный ресурс)

### Зонирование карты

#### Центральная зона (40% радиуса от центра)
- **Кристаллы**: Эксклюзивно размещаются только в центральной зоне
- **Золото**: 40% всех золотых месторождений (крупные и богатые)
- **Железо**: Отсутствует в центральной зоне
- **Характеристики**: Самые богатые и крупные месторождения

#### Средняя зона (40-70% радиуса от центра)
- **Золото**: 60% всех золотых месторождений (средний размер)
- **Железо**: Основная зона размещения железных месторождений
- **Кристаллы**: Отсутствуют в средней зоне

#### Внешняя зона (70-100% радиуса от центра)
- **Железо**: Дополнительные железные месторождения
- **Золото**: Отсутствует во внешней зоне
- **Кристаллы**: Отсутствуют во внешней зоне

## Алгоритм размещения ресурсов

### Расчет количества ресурсов
```
Базовая плотность = 2.5% от площади карты
Множитель игроков = 1.3^(количество_игроков - 2)

Золотые кластеры = floor(площадь * базовая_плотность * множитель_игроков)
Железные кластеры = floor(золотые_кластеры * 0.8)  // 80% от золота
Кристальные кластеры = floor(золотые_кластеры * 0.3)  // 30% от золота
```

### Характеристики кластеров по зонам

#### Кристальные кластеры (только центр)
- **Радиус**: 3-6 клеток
- **Плотность**: 95% (очень плотные)
- **Алгоритм**: Неразрывные области с заливкой

#### Золотые кластеры
**Центральная зона:**
- **Радиус**: 4-7 клеток
- **Плотность**: 85%

**Средняя зона:**
- **Радиус**: 2-5 клеток
- **Плотность**: 75%

#### Железные кластеры (средняя и внешняя зоны)
- **Радиус**: 3-7 клеток
- **Плотность**: 70%

### Алгоритм создания неразрывных областей

Новый алгоритм использует **заливку с вероятностным расширением**:

1. **Инициализация**: Размещение центра кластера
2. **Заливка**: Алгоритм BFS (breadth-first search) для расширения области
3. **Вероятность размещения**: Уменьшается с расстоянием от центра
4. **Соседство**: Проверка 8 направлений (включая диагонали)
5. **Результат**: Связная область ресурсов без пробелов

```
Вероятность = базовая_плотность * (1 - distance^0.8 / radius) + шум
```

### Правила размещения кластеров

#### Минимальные расстояния
- **Между кластерами одного типа**: 8 клеток
- **Между кластерами разных типов**: 15 клеток
- **От точек спавна игроков**: 12 клеток

#### Защищенные зоны
- **Центр кластера**: Всегда содержит ресурс (вероятность = 100%)
- **Спавн-зоны**: Автоматически очищаются от ресурсов при генерации стартовых зон

## Стартовые зоны игроков

### Структура стартовой зоны

#### Немедленная зона строительства (радиус 0-2)
- **Тип поверхности**: Empty (очищенная)
- **Назначение**: Мгновенное размещение зданий

#### Зона доступности (радиус 3-4)
- **Поверхности**: Dirt/Rock (убирается Bedrock)
- **Очистка ресурсов**: Все ресурсы заменяются на Dirt
- **Назначение**: Легкое расширение базы

#### Гарантированные ресурсы (радиус 5-8)

**Железное месторождение:**
- **Размер**: Радиус 2 клетки
- **Плотность**: 80%
- **Размещение**: Случайный угол от спавна

**Золотое месторождение:**
- **Размер**: Радиус 2 клетки
- **Плотность**: 80%
- **Размещение**: Противоположная сторона от железа (±90°)

### Расчет позиций спавна
- **1 игрок**: Центр карты
- **2 игрока**: Диагональные углы
- **3-4 игрока**: По углам карты
- **5+ игроков**: Углы + центры сторон

## Механики взаимодействия

### Раскопка поверхности
```
Dirt → Empty
Rock → Empty
GoldCluster → Empty + золото
CrystalCluster → Empty + кристаллы
IronCluster → Empty + железо
Bedrock → Неразрушимо
```

### События системы
- `terrain.dug` - Поверхность раскопана
- `resource_mined` - Ресурс добыт из кластера
- `resource_depleted` - Кластер полностью истощен

## Балансировка

### Стратегические принципы
1. **Центр как цель**: Лучшие ресурсы в центре стимулируют конфликты
2. **Справедливый старт**: Гарантированные ресурсы у каждого игрока
3. **Прогрессия сложности**: От железа к золоту к кристаллам
4. **Территориальный контроль**: Разделение типов ресурсов по зонам

### Экономический баланс
- **Железо**: Обильно, необходимо для строительства
- **Золото**: Умеренно, основная валюта
- **Кристаллы**: Редко, продвинутые технологии

### Адаптация под количество игроков
- **Масштабирование**: Больше игроков = больше ресурсов
- **Плотность**: Остается постоянной для сохранения баланса
- **Зонирование**: Неизменно независимо от количества игроков

## ASCII-визуализация

Символы для отладки карты:
- `.` = Dirt
- `#` = Rock
- `X` = Bedrock
- ` ` = Empty
- `G` = Gold Cluster
- `C` = Crystal Cluster
- `I` = Iron Cluster
- `?` = Unknown/Error

## Технические детали реализации

### Алгоритм зонирования
```typescript
centralZoneRadius = maxDistanceFromCenter * 0.4
middleZoneRadius = maxDistanceFromCenter * 0.7
outerZone = все остальное
```

### Поиск позиций в зонах
- **Полярные координаты**: Угол + расстояние для равномерного распределения
- **Проверки конфликтов**: Расстояние до спавнов и других кластеров
- **Границы карты**: Отступ 5 клеток от края

### Оптимизация производительности
- **Ограничение попыток**: Максимум 200 попыток поиска позиции
- **Ранний выход**: Прекращение при невозможности размещения
- **Кэширование**: Использование Set для проверки посещенных клеток
